ARG CI_COMMIT_REF_SLUG
ARG CI_COMMIT_SHA
ARG GCLOUD_PROJECT_ID
ARG PHP_VERSION

FROM eu.gcr.io/${GCLOUD_PROJECT_ID}/img/php:${CI_COMMIT_REF_SLUG}-builder-${CI_COMMIT_SHA} as builder

FROM gcr.io/cloud-builders/gsutil:latest

ARG CI_COMMIT_REF_SLUG
ARG CI_COMMIT_SHA
ARG GCLOUD_GITLAB_RUNNER_SERVICE_KEY
ARG GCLOUD_ARTIFACTS_BUCKET
ARG GCLOUD_PROJECT_ID

COPY --from=builder /tmp/artefact.tar.gz /tmp/artefact.tar.gz

RUN \
  echo $GCLOUD_GITLAB_RUNNER_SERVICE_KEY | base64 -d > ~/gcloud-gitlab-runner-service-key.json && \
  gcloud auth activate-service-account gitlab-runner@${GCLOUD_PROJECT_ID}.iam.gserviceaccount.com --key-file ~/gcloud-gitlab-runner-service-key.json && \
  gcloud config set project ${GCLOUD_PROJECT_ID} && \
  gsutil copy /tmp/artefact.tar.gz gs://${GCLOUD_ARTIFACTS_BUCKET}/${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHA}.tar.gz && \
  gsutil copy /tmp/artefact.tar.gz gs://${GCLOUD_ARTIFACTS_BUCKET}/${CI_COMMIT_REF_SLUG}-latest.tar.gz

FROM wodby/drupal-php:${PHP_VERSION}

COPY --from=builder /tmp/artefact.tar.gz /tmp/artefact.tar.gz

ARG CI_COMMIT_SHA

USER root

RUN \
  cd /var/www/html && \
  mv /tmp/artefact.tar.gz . && \
  COMMIT_SHA=${CI_COMMIT_SHA} && \
  tar zxfv ./artefact.tar.gz > /dev/null && \
  chown -R wodby:wodby /var/www/html

USER wodby
