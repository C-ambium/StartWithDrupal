ARG CI_COMMIT_SHA
ARG CI_COMMIT_REF_SLUG
ARG GCLOUD_PROJECT_ID

# hack in order to be able to use the COPY with var args
FROM eu.gcr.io/${GCLOUD_PROJECT_ID}/img/php:${CI_COMMIT_REF_SLUG}-builder-${CI_COMMIT_SHA} as builder

FROM wodby/php-apache:2.4-2.0.0

ARG CI_COMMIT_SHA
ARG CI_COMMIT_REF_SLUG
ARG GCLOUD_PROJECT_ID

USER root

COPY --from=builder /tmp/artefact.tar.gz /tmp/artefact.tar.gz

RUN \
  cp /tmp/artefact.tar.gz . && \
  ls -al /tmp && \
  COMMIT_SHA=${CI_COMMIT_SHA} && \
  cd /var/www/html && \
  tar zxfv /tmp/artefact.tar.gz > /dev/null  && \
  chown -R 82:82 /var/www/html

USER 82
