ARG CI_COMMIT_SHA
ARG CI_COMMIT_REF_SLUG
ARG GCLOUD_PROJECT_ID
ARG APACHE_VERSION

# hack in order to be able to use the COPY with var args
FROM eu.gcr.io/${GCLOUD_PROJECT_ID}/img/php:${CI_COMMIT_REF_SLUG}-builder-${CI_COMMIT_SHA} as builder

FROM wodby/apache:${APACHE_VERSION}

ARG CI_COMMIT_SHA

USER root

COPY --from=builder /tmp/artefact.tar.gz /tmp/artefact.tar.gz

RUN \
  cp /tmp/artefact.tar.gz . && \
  ls -al /tmp && \
  COMMIT_SHA=${CI_COMMIT_SHA} && \
  cd /var/www/html && \
  tar zxfv /tmp/artefact.tar.gz > /dev/null  && \
  chown -R wodby:wodby /var/www/html

USER wodby
